<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>LEX Displacement</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
  <link href="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>

</head>
<style>
  .legend {
    padding: 6px 8px;
    font-size: 1em;
    background: rgba(75, 75, 75, 0.8);
    color: whitesmoke;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    width: 160px;
  }

  .legend h3 {
    font-size: 1.1em;
    font-weight: bold;
    line-height: 1em;
    color: whitesmoke;
    margin: 0;
  }

  .legend h3 span {
    font-size: 1.3em;
    margin: 0 20px 0 0;
  }

  .legend ul {
    list-style-type: none;
    padding: 0;
    margin: 12px 4px 0;
  }

  .legend li {
    height: 22px;
  }

  .legend span {
    width: 30px;
    height: 20px;
    float: left;
    margin-right: 10px;
  }

  #ui-controls {
    width: 176px;
    padding: 8px 25px 8px 15px;
    background: rgba(75, 75, 75, 0.8);
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    color: whitesmoke;
  }

  #ui-controls .min {
    float: left;
  }

  #ui-controls .max {
    float: right;
    margin-right: -15px;
  }

  .year-slider {
    width: 100%;
  }

  label {
    font-size: 1.1em;
    font-weight: bold;
  }
</style>

<body>

  <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.js"></script>
  <div class='flex-parent viewport-full relative scroll-hidden'>
    <div class='flex-child w-full w300-ml absolute static-ml left bottom'>
      <div class='flex-parent flex-parent--column viewport-third h-full-ml hmax-full bg-white py18 px12'>
        <div class='flex-child flex-child--grow px12 py12 scroll-auto'>
          <h1 class='txt-h2 mb6'>Displaced: Exploring the racialized dimensions of gentrification</h1>
          <br>
          <p>TEXT & IMAGES HERE</p>
        </div>
        <footer class='px12 py12 bg-gray-faint txt-s'>
          <ul>
            <li>Explore the raw
              <a class='link' href='https://www.opendata.go.ke/datasets/national-boys-and-girls-enrollments-per-class-for-primary-school-education'>data</a>
            </li>
            <li>Map authored by
              <a class='link' href='https://geography.as.uky.edu/users/eba287'>Emily Barrett</a>
            </li>
          </ul>
        </footer>
      </div>
    </div>
    <div class='flex-child flex-child--grow viewport-twothirds viewport-full-ml'>
      <div id="map" class='viewport-twothirds viewport-full-ml'></div>
      <!-- ui slider -->
      <div id="ui-controls">
        <input type="range" min="2013" , max="2018" , value="2013" , step="1" class="year-slider"></input>
      </div>
      <!-- ui is outside of container-fluid and will be dynamically added to map -->
      <div class="form-group mr-3 mt-3" id="dropdown-ui">
        <select class="form-control bg-dark text-black">
          <option value="OWNED_MORT" selected>Black</option>
          <option value="OWNED_FREE">White</option>
          <option value="RENTER">Hispanic</option>
        </select>
      </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>

    <script>
      const map = L.map('map', {
        zoomSnap: .1,
        center: [38.047989, -84.501640],
        zoom: 11,
        // minZoom: 7,
      });

      const accessToken = 'pk.eyJ1IjoiZWJhMjg3IiwiYSI6ImNrOXgya2tiaDAyM28zZXFkNXV5N25zdnEifQ.hRIQRtOQlL09t15yLq_y_A'

      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + accessToken, {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.light',
        accessToken: accessToken
      }).addTo(map);

      // set global variables for map layer,
      // mapped attribute, and normalizing attribute
      let attributeValue = "OWNED_MORT";
      const normValue = "OCCUPIED";

      // create object to hold legend titles
      const labels = {
        "OWNED_MORT": "Occupied housing units owned with mortgage",
        "OWNED_FREE": "Occupied housing units owned free and clear",
        "RENTER": "Occupied housing units rented"
      }

      $.getJSON("data/bg2010.json", function(counties) {

        Papa.parse('data/black2.csv', {

          download: true,
          header: true,
          complete: function(data) {

            processData(counties, data);


          }
        });

      });

      function processData(counties, data) {

        // console.log(counties);

        // loop through all the counties
        for (let i of counties.features) {

          // for each of the CSV data rows
          for (let j of data.data) {

            // if the county fips code and data fips code match
            if (i.properties.GEOID10 === j.GEOID10) {

              // re-assign the data for that county as the county's props
              i.properties = j;

              // no need to keep looping, break from inner loop
              break;
            }
          }

        }
        // console.log('after: ', counties);

        // empty array to store all the data values
        const rates = [];

        // iterate through all the counties
        counties.features.forEach(function(county) {

          // iterate through all the props of each county
          for (const prop in county.properties) {

            // if the attribute is a number and not one of the fips codes or name
            if (prop != "GEOID" && prop != "GEOID10" && prop != "NAME") {

              // push that attribute value into the array
              rates.push(Number(county.properties[prop]));
            }
          }
        });

        // verify the result!
        console.log(rates);

        // create class breaks
        var breaks = chroma.limits(rates, 'q', 5);

        // create color generator function
        var colorize = chroma.scale(chroma.brewer.OrRd).classes(breaks).mode('lab');

        drawMap(counties, colorize);
        drawLegend(breaks, colorize);
      }
      //

      function drawMap(counties, colorize) {

        // create Leaflet object with geometry data and add to map
        const dataLayer = L.geoJson(counties, {
          style: function(feature) {
            return {
              color: 'black',
              weight: 1,
              fillOpacity: 1,
              fillColor: '#1f78b4'
            };
          }
        }).addTo(map);

        // first set the zoom/center to the dataLayer's extent
        map.fitBounds(dataLayer.getBounds());

        // then back the zoom level off a bit (since we're viewing the map full screen)
        map.setZoom(map.getZoom() - .2);

        updateMap(dataLayer, colorize, '2013');
        createSliderUI(dataLayer, colorize);

      }

      function updateMap(dataLayer, colorize, currentYear) {

        dataLayer.eachLayer(function(layer) {
          const props = layer.feature.properties;
          // console.log(layer.feature.properties);

          layer.setStyle({
            fillColor: colorize(Number(props[currentYear]))
          })


          const tooltip = `<b>${props['NAME']}</b><br />
          ${props[currentYear]} % LABEL HERE`;

          layer.bindTooltip(tooltip, {
            sticky: true

          });
        });
        addUi(dataLayer); // add the UI controls

      }

      function drawLegend(breaks, colorize) {
        // create a Leaflet control for the legend
        const legendControl = L.control({
          position: 'topright'
        });

        // when the control is added to the map
        legendControl.onAdd = function(map) {

          // create a new division element with class of 'legend' and return
          const legend = L.DomUtil.create('div', 'legend');
          return legend;

        };

        // add the legend control to the map
        legendControl.addTo(map);

        // select div and create legend title
        const legend = $('.legend').html("<h3><span>2013</span>Population</h3><ul>");

        // loop through the break values
        for (let i = 0; i < breaks.length - 1; i++) {

          // determine color value
          const color = colorize(breaks[i], breaks);

          // create legend item
          const classRange = `<li><span style="background:${color}"></span>
          ${breaks[i].toLocaleString()} &mdash;
          ${breaks[i + 1].toLocaleString()}% </li>`

          // append to legend unordered list item
          $('.legend ul').append(classRange);
        }
        // close legend unordered list
        legend.append("</ul>");

      } // end drawLegend()

      function createSliderUI(dataLayer, colorize) {
        // create Leaflet control for the slider
        const sliderControl = L.control({
          position: 'bottomleft'
        });

        // when added to the map
        sliderControl.onAdd = function(map) {

          // select an existing DOM element with an id of "ui-controls"
          const slider = L.DomUtil.get("ui-controls");

          // disable scrolling of map while using controls
          L.DomEvent.disableScrollPropagation(slider);

          // disable click events while using controls
          L.DomEvent.disableClickPropagation(slider);

          // return the slider from the onAdd method
          return slider;
        }

        // add the control to the map
        sliderControl.addTo(map);
        // select the form element
        $(".year-slider")
          .on("input change", function() { // when user changes
            const currentYear = this.value; // update the year
            $('.legend h3 span').html(currentYear); // update the map with current timestamp
            updateMap(dataLayer, colorize, currentYear); // update timestamp in legend heading
          });

      } // end createSliderUI()

      function addUi(dataLayer) {
        // create the slider control
        var selectControl = L.control({
          position: "topright"
        });

        // when control is added
        selectControl.onAdd = function() {
          // get the element with id attribute of ui-controls
          return L.DomUtil.get("dropdown-ui");
        };
        // add the control to the map
        selectControl.addTo(map);

        $('#dropdown-ui select').change(function() {
          // code executed here when change event occurs
          // console.log(`Something changed at ${Date.now()}`);
          // console.log(this.value);
          attributeValue = this.value;

          // call updateMap function
          updateMap(dataLayer);
        });
      }
    </script>

</body>

</html>
